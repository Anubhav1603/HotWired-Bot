import aiohttp

from contextlib import suppress
from os.path import splitext

from discord import Color, Embed, Message, NotFound
from discord.ext.commands import Bot, Cog

from assets import AntiMalware

from .utils import constants

FILE_EMBED_DESCRIPTION = (
    f"""
    **Oh No!** Your message got zapped by our spam filter.
    We currently don't allow `.txt` attahcments or any source files, so here are some tips to you can do: \n
    • Try shortening messages if the length is above 2000 characters to fit within the character limit or use a pasting service\n
    • For showing someone your code, you can use codeblocks or use a pasting service like: \n{constants.paste_link} or {constants.paste_link_2}
    """
)


class MalwareProtection(Cog):
    def __init__(self, bot: Bot) -> None:
        self.bot = bot

    @Cog.listener()
    async def on_message(self, message: Message) -> None:
        """Find messages with blacklisted attachments."""
        if not message.attachments or not message.guild:
            return

        # elif message.author.guild_permissions.administrator:
        #     return

        file_extensions = {splitext(attachment.filename.lower())[1] for attachment in message.attachments}
        is_blocked = file_extensions - set(AntiMalware.whitelist)

        if is_blocked:
            embed = Embed(color=Color.gold())
            embed.description = FILE_EMBED_DESCRIPTION

        if embed.description:
            with suppress(NotFound, ConnectionError):
                file_pastes = []

                for attachment in message.attachments:
                    content = await attachment.read()
                    async with aiohttp.ClientSession() as session:
                        async with session.post('https://www.hastebin.com/documents', data=content) as resp:
                            data = await resp.json()
                            key = data['key']
                            file_paste = 'https://www.hastebin.com/' + key
                            file_pastes.append(file_paste)

                    paste_embed = Embed(
                        color=Color.red(),
                        description=f"The Paste(s) of the File(s) Can be found at {','.join(file_pastes)}",
                        title="File Pastes!"
                    )
                    await message.delete()
                    await message.channel.send(f"Hey {message.author.mention}!", embed=embed)
                    await message.channel.send(embed=paste_embed)


def setup(bot: Bot) -> None:
    bot.add_cog(MalwareProtection(bot))
